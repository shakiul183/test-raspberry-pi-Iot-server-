<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IoT Live Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #f8fafc;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      margin: 20px 0;
      color: #38bdf8;
    }
    h2 {
      margin-top: 30px;
      color: #fbbf24;
    }
    .status {
      padding: 10px;
      margin: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
    }
    .status.connected {
      background: #10b981;
      color: white;
    }
    .status.disconnected {
      background: #ef4444;
      color: white;
    }
    .container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin: 20px;
    }
    .card {
      background: #1e293b;
      padding: 20px;
      margin: 10px;
      border-radius: 12px;
      min-width: 250px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .title {
      font-size: 18px;
      margin-bottom: 10px;
      color: #fbbf24;
      font-weight: bold;
    }
    .value {
      font-size: 24px;
      color: #38bdf8;
      margin: 5px 0;
    }
    .timestamp {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 10px;
    }
    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .sensor-item {
      background: #334155;
      padding: 10px;
      border-radius: 8px;
    }
    .sensor-label {
      font-size: 12px;
      color: #94a3b8;
    }
    .sensor-value {
      font-size: 18px;
      color: #38bdf8;
      font-weight: bold;
    }
    .logs {
      margin: 20px;
      padding: 15px;
      background: #1e293b;
      border-radius: 8px;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #38bdf8;
      padding-left: 10px;
    }
  </style>
</head>
<body>
  <h1>üåê IoT Live Dashboard</h1>
  
  <div id="connectionStatus" class="status disconnected">
    Disconnected
  </div>

  <h2>üì° Raspberry Pi Data</h2>
  <div class="container" id="piContainer">
    <div class="card">
      <div class="title">Waiting for data...</div>
    </div>
  </div>

  <h2>‚òÅÔ∏è AWS Server Data</h2>
  <div class="container" id="serverContainer">
    <div class="card">
      <div class="title">Waiting for data...</div>
    </div>
  </div>

  <h2>üìã Connection Logs</h2>
  <div class="logs" id="logs"></div>

  <script>
    // IMPORTANT: Change these settings to match your MQTT broker
    const BROKER_URL = 'ws://13.233.166.78'; // WebSocket port (usually 9001)
    // If using secure WebSocket: 'wss://your-broker:8084'
    
    const PI_TOPIC = 'myiot/device/data';
    const SERVER_TOPIC = 'myiot/server/data';

    let client;
    const piContainer = document.getElementById('piContainer');
    const serverContainer = document.getElementById('serverContainer');
    const statusDiv = document.getElementById('connectionStatus');
    const logsDiv = document.getElementById('logs');

    function addLog(message, type = 'info') {
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      const timestamp = new Date().toLocaleTimeString();
      logEntry.textContent = `[${timestamp}] ${message}`;
      logsDiv.insertBefore(logEntry, logsDiv.firstChild);
      
      // Keep only last 20 logs
      while (logsDiv.children.length > 20) {
        logsDiv.removeChild(logsDiv.lastChild);
      }
    }

    function updateStatus(connected) {
      if (connected) {
        statusDiv.textContent = '‚úÖ Connected to MQTT Broker';
        statusDiv.className = 'status connected';
      } else {
        statusDiv.textContent = '‚ùå Disconnected from MQTT Broker';
        statusDiv.className = 'status disconnected';
      }
    }

    function displayPiData(data) {
      const html = `
        <div class="card">
          <div class="title">Device: ${data.device_id || 'Unknown'}</div>
          <div class="value">${data.status || 'Active'}</div>
          <div class="timestamp">${new Date(data.timestamp).toLocaleString()}</div>
          ${data.sensors ? `
            <div class="sensor-grid">
              ${Object.entries(data.sensors).map(([key, value]) => `
                <div class="sensor-item">
                  <div class="sensor-label">${key}</div>
                  <div class="sensor-value">${typeof value === 'number' ? value.toFixed(2) : value}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
      piContainer.innerHTML = html;
      addLog(`Received Pi data: ${data.device_id}`);
    }

    function displayServerData(data) {
      const html = `
        <div class="card">
          <div class="title">Device: ${data.device_id || 'Unknown'}</div>
          <div class="value">${data.status || 'Active'}</div>
          <div class="timestamp">${new Date(data.timestamp).toLocaleString()}</div>
          ${data.sensors ? `
            <div class="sensor-grid">
              ${Object.entries(data.sensors).map(([key, value]) => `
                <div class="sensor-item">
                  <div class="sensor-label">${key}</div>
                  <div class="sensor-value">${typeof value === 'number' ? value.toFixed(2) : value}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
      serverContainer.innerHTML = html;
      addLog(`Received Server data: ${data.device_id}`);
    }

    // Connect to MQTT broker
    addLog('Attempting to connect to MQTT broker...');
    
    try {
      client = mqtt.connect(BROKER_URL, {
        clientId: 'WebDashboard_' + Math.random().toString(16).substr(2, 8),
        clean: true,
        reconnectPeriod: 5000,
        connectTimeout: 30000
      });

      client.on('connect', () => {
        addLog('‚úÖ Connected to MQTT broker successfully!');
        updateStatus(true);
        
        // Subscribe to topics
        client.subscribe(PI_TOPIC, (err) => {
          if (!err) {
            addLog(`Subscribed to ${PI_TOPIC}`);
          } else {
            addLog(`Failed to subscribe to ${PI_TOPIC}: ${err.message}`, 'error');
          }
        });

        client.subscribe(SERVER_TOPIC, (err) => {
          if (!err) {
            addLog(`Subscribed to ${SERVER_TOPIC}`);
          } else {
            addLog(`Failed to subscribe to ${SERVER_TOPIC}: ${err.message}`, 'error');
          }
        });
      });

      client.on('message', (topic, message) => {
        try {
          const data = JSON.parse(message.toString());
          
          if (topic === PI_TOPIC) {
            displayPiData(data);
          } else if (topic === SERVER_TOPIC) {
            displayServerData(data);
          }
        } catch (e) {
          addLog(`Error parsing message: ${e.message}`, 'error');
          console.error('Parse error:', e, 'Message:', message.toString());
        }
      });

      client.on('error', (err) => {
        addLog(`‚ùå Connection error: ${err.message}`, 'error');
        updateStatus(false);
      });

      client.on('close', () => {
        addLog('Connection closed');
        updateStatus(false);
      });

      client.on('offline', () => {
        addLog('Client is offline');
        updateStatus(false);
      });

      client.on('reconnect', () => {
        addLog('Attempting to reconnect...');
      });

    } catch (e) {
      addLog(`‚ùå Failed to create MQTT client: ${e.message}`, 'error');
    }
  </script>
</body>
</html>
 